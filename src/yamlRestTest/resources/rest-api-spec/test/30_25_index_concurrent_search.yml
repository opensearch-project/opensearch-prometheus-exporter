---
"Node level concurrent segment search statistics":

  # -----------------------------------
  # Verify node-level concurrent search metrics are present
  # These metrics track search queries that use concurrent segment search

  - do:
      prometheus.metrics: {}

  # Test indices_search_concurrent_query_count
  - match:
      $body: |
        /.*
        \# \s HELP \s opensearch_indices_search_concurrent_query_count \s Count \s of \s search \s queries \s that \s use \s concurrent \s segment \s search \n
        \# \s TYPE \s opensearch_indices_search_concurrent_query_count \s gauge \n
        opensearch_indices_search_concurrent_query_count\{
            cluster="yamlRestTest",node="[a-zA-Z0-9\-\.\_]+",nodeid="[a-zA-Z0-9\-\.\_]+"
        ,\} \s+ \d+\.\d+
        .*/

  # Test indices_search_concurrent_query_current_number
  - match:
      $body: |
        /.*
        \# \s HELP \s opensearch_indices_search_concurrent_query_current_number \s Current \s rate \s of \s search \s queries \s that \s use \s concurrent \s segment \s search \n
        \# \s TYPE \s opensearch_indices_search_concurrent_query_current_number \s gauge \n
        opensearch_indices_search_concurrent_query_current_number\{
            cluster="yamlRestTest",node="[a-zA-Z0-9\-\.\_]+",nodeid="[a-zA-Z0-9\-\.\_]+"
        ,\} \s+ \d+\.\d+
        .*/

  # Test indices_search_concurrent_query_time_seconds
  - match:
      $body: |
        /.*
        \# \s HELP \s opensearch_indices_search_concurrent_query_time_seconds \s Time \s spent \s on \s search \s queries \s that \s use \s concurrent \s segment \s search \n
        \# \s TYPE \s opensearch_indices_search_concurrent_query_time_seconds \s gauge \n
        opensearch_indices_search_concurrent_query_time_seconds\{
            cluster="yamlRestTest",node="[a-zA-Z0-9\-\.\_]+",nodeid="[a-zA-Z0-9\-\.\_]+"
        ,\} \s+ \d+\.\d+
        .*/

  # Test indices_search_concurrent_avg_slice_count
  - match:
      $body: |
        /.*
        \# \s HELP \s opensearch_indices_search_concurrent_avg_slice_count \s Average \s slice \s count \s per \s concurrent \s segment \s search \s request \n
        \# \s TYPE \s opensearch_indices_search_concurrent_avg_slice_count \s gauge \n
        opensearch_indices_search_concurrent_avg_slice_count\{
            cluster="yamlRestTest",node="[a-zA-Z0-9\-\.\_]+",nodeid="[a-zA-Z0-9\-\.\_]+"
        ,\} \s+ \d+\.\d+
        .*/
